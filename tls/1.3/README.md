# TLS 1.3科普——新特性与协议实现

上海交通大学密码与计算机安全实验室（LoCCS）软件安全小组（GoSSIP）版权所有，转载请与作者取得联系！

在今年的GoSSIP软件安全小组面向全国优秀的本科同学开放的暑期实习中，来自上海交通大学的**胡嘉尚**同学深入研究了SSL/TLS协议，并撰写了这篇TLS 1.3的科普文章，希望能够帮助国内的安全研究人员和企业开发人员更加深入地理解和部署TLS 1.3协议。

时隔九年之后的新升级，TLS 1.3备受关注。针对目前已知的漏洞和安全威胁，IETF小组对TLS协议进行了一次大的更新，从2014年4月，第0份TLS 1.3草案公开，到2017年7月第21份草案发布，TLS 1.3的编写工作已经进入尾声，跨时3年的编写，让该协议成为有史以来最安全、也是最复杂的TLS协议。

正式的RFC虽然尚未发布，TLS 1.3已经开始被国内外一些网站使用，Chrome、Firefox、OpenSSL、Nginx等均提供了相应支持，TLS 1.3已经悄然进入我们的生活。借着这篇文章先来了解一下吧~

## 简介

20年——从开始到现在

对于安全加密通信，传输层安全协议（SSL/TLS）的重要性不言而喻。
起初，网景公司针对传输层协议（TCP/UDP）并没有对传输的数据进行加密保护的缺陷，为自家浏览器设计了SSL协议，于1995年公开协议的2.0版本。1999年，IETF小组基于SSL 3.0设计了与SSL协议独立的TLS 1.0协议，正式成为互联网传输层加密的标准。此后，TLS协议于2006年、2008年再次经历更新，分别命名为TLS 1.1和TLS 1.2。
如今的TLS协议不仅被用于传输层通讯，更作为一个标准的加密保护协议被广泛应用于 FTP, 电子邮件和VPN等领域，时刻保护着我们网络通信的安全。

### 当前的TLS协议存在问题

老版本的SSL协议被公认在完整性校验、密钥协商过程中有重大缺陷，因此，2011年与2015年IETF小组相继声明禁止使用SSL 2.0、3.0。
TLS协议针对此前披露的漏洞做了相应的处理，但是因为其复杂性，还没有一个版本能真正保证绝对的安全。
目前最新版本的TLS 1.2发布距今已有九年时间，在此期间，许多SSL/TLS协议的新漏洞被发现，比如针对其压缩机制的CRIME漏洞，针对CBC块加密模式的BEAST漏洞（主要是针对SSL 3.0和TLS 1.0），早已不再是当初设计者认为的那么安全，人们迫切需要新的协议将其代替。

### TLS1.3与之前的协议有较大差异

SSL/TLS协议为网络通信提供了以下两种功能：

建立一个安全的连接：对其中传输的数据提供加密保护，防止被中间人嗅探到可见明文；对数据提供完整性校验，防止传输的数据被中间人修改。
建立一个可信的连接：对连接双方的实体提供身份认证。
上述功能在以往的TLS协议中是这样实现的：

* 加密：使用对称加密算法（块加密、流加密）加密会话数据，密钥交换主要通过非对称算法加密会话过程中使用的对称密钥传递给对方来实现（RSA）。从TLS 1.0起引入了DH密钥交换算法作为另一种可选的密钥交换算法。
* 完整性校验：使用MAC对发送的报文进行完整性校验计算，先计算MAC再加密。在TLS 1.2中引入了更具有安全性的AEAD算法（同时完成加密和完整性校验）作为一个加密机制的备选选项 。
* 身份认证：所有的身份认证都基于证书公钥体系完成。

因为RSA密钥交换过程安全性完全依赖于服务器私钥的安全性，TLS 1.3彻底废弃了RSA密钥交换算法。
因为先计算MAC再加密的方法存在相当的安全缺陷，TLS 1.3废弃了使用MAC的块加密和流加密机制，仅采用AEAD类对称加密算法作为唯一的加密选项。
此外，TLS 1.3引入了一种新的密钥协商机制——PSK。

其他新协议大的改变还包括：
- 支持0-RTT数据传输
- 废弃了3DES、RC4、AES-CBC等加密组件。废弃了SHA1、MD5等哈希算法。
- 不再允许对加密报文进行压缩、不再允许双方发起重协商，密钥的改变不再需要发送change_cipher_spec报文给对方。
- 握手阶段的报文可见明文大大减少。

对比以往的协议RFC中不足一页的Major Differences from Previous。TLS 1.3确实可以称得上是向前的一大步。

### TLS 1.3包括3个子协议-alert, handshake, record

* alert协议负责处理消息传输与握手阶段中的异常情况。
* handshake协议负责协商使用的TLS版本、加密算法、哈希算法、密钥材料和其他与通信过程有关的信息，对服务器进行身份认证，对客户端进行可选的身份认证，最后对整个握手阶段信息进行完整性校验以防范中间人攻击，是整个TLS协议的核心。
* record协议负责对接收到的报文进行加密解密，将其分片为合适的长度后转发给其他协议层。

此前的协议中还定义了一个子协议change_cipher_spec来决定何时对传递的数据进行加密，TLS 1.3取消了这一机制，密钥的使用和改变随着服务器和客户端状态的改变自然进行。

## 新的术语

### PSK（pre_shared_key）——新的密钥交换暨身份认证机制

0-RTT：客户端和服务端的一次交互（客户端发一个报文，服务端回应一个报文）叫做一个RTT，TLS 1.2普遍采用2-RTT的握手过程，服务器延迟明显。因此TLS 1.3引入了一种0-RTT的机制，即在刚开始TLS密钥协商的时候，就能附送一部分经过加密的数据传递给对方。
为了实现0-RTT，需要双方在刚开始建立连接的时候就已经持有一个对称密钥，这个密钥在TLS 1.3中称为PSK（pre_shared_key）。
PSK是TLS 1.2中的rusumption机制的一个升级，TLS握手结束后，服务器可以发送一个NST（new_session_ticket）的报文给客户端，该报文中记录PSK的值、名字和有效期等信息，双方下一次建立连接可以使用该PSK值作为初始密钥材料。
因为PSK是从以前建立的安全信道中获得的，只要证明了双方都持有相同的PSK，不再需要证书认证，就可以证明双方的身份，因此，PSK也是一种身份认证机制。
ps: 0-RTT的实现有一定的安全缺陷，自身没有抗重放攻击的机制
在TLS 1.3草案中提出了几个对性能消耗比较大的可能的解决方法，感兴趣的话可以找来读一读。
HKDF（HMAC_based_key_derivation_function）——新的密钥导出函数

经过密钥协商得出来的密钥材料因为随机性可能不够，协商的过程能被攻击者获知，需要使用一种密钥导出函数来从初始密钥材料（PSK或者DH密钥协商计算出来的key）中获得安全性更强的密钥。
HKDF正是TLS 1.3中所使用的这样一个算法，使用协商出来的密钥材料和握手阶段报文的哈希值作为输入，可以输出安全性更强的新密钥。
HKDF包括extract_then_expand的两阶段过程。extract过程增加密钥材料的随机性，在TLS 1.2中使用的密钥导出函数PRF实际上只实现了HKDF的expand部分，并没有经过extract，而直接假设密钥材料的随机性已经符合要求。
AEAD（Authenticated_Encrypted_with_associated_data）——唯一保留的加密方式

TLS协议的最终目的是协商出会话过程使用的对称密钥和加密算法，双方最终使用该密钥和对称加密算法对报文进行加密。
AEAD将完整性校验和数据加密两种功能集成在同一算法中完成，是TLS 1.3中唯一支持的加密方式。TLS 1.2还支持流加密和CBC分组模式的块加密方法，使用MAC来进行完整性校验数据，这两种方式均被证明有一定的安全缺陷。
但是有研究表明AEAD也有一定局限性：使用同一密钥加密的明文达到一定长度后，就不能再保证密文的安全性。因此，TLS 1.3中引入了密钥更新机制，一方可以（通常是服务器）向另一方发送Key Update（KU）报文，对方收到报文后对当前会话密钥再使用一次HKDF，计算出新的会话密钥，使用该密钥完成后续的通信。
